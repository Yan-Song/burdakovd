#!/usr/bin/lua5.1

local start = os.clock()
require "enhancements"

local cases = {
    10546,10548,11622,11642,11643,11644,11645,11646,11647,11648,11649,12645,15564,18169,18170,18171,18172,18173,18182,
    18251,18283,18329,18330,18331,19782,19783,19784,19785,19786,19787,19788,19789,19790,19971,20076,20077,20078,22635,
    22636,22638,2304,2313,23530,23545,23547,23548,23549,23764,23765,23766,24273,24274,24275,24276,25650,25651,25652,
    28881,28882,28885,28886,28887,28888,28889,28903,28904,28907,28908,28909,28910,28911,28912,29186,29187,29189,29190,
    29191,29192,29193,29194,29195,29196,29197,29198,29199,29483,29485,29486,29487,29488,29533,29534,29535,29536,30845,
    30846,33185,34207,34330,34836,37312,37603,38371,38372,38373,38374,38375,38376,38679,38766,38767,38768,38769,38770,
    38771,38772,38773,38774,38775,38776,38777,38778,38779,38780,38781,38782,38783,38784,38785,38786,38787,38788,38789,
    38791,38792,38793,38794,38795,38796,38797,38798,38799,38800,38801,38802,38803,38804,38805,38806,38807,38808,38809,
    38810,38811,38812,38813,38814,38815,38816,38817,38818,38819,38820,38821,38822,38823,38824,38825,38826,38827,38828,
    38829,38830,38831,38832,38833,38834,38835,38836,38837,38838,38839,38840,38841,38842,38843,38844,38845,38846,38847,
    38848,38849,38850,38851,38852,38853,38854,38855,38856,38857,38858,38859,38860,38861,38862,38863,38864,38865,38866,
    38867,38868,38869,38870,38871,38872,38873,38874,38875,38876,38877,38878,38879,38880,38881,38882,38883,38884,38885,
    38886,38887,38888,38889,38890,38891,38892,38893,38894,38895,38896,38897,38898,38899,38900,38901,38902,38903,38904,
    38905,38906,38907,38908,38909,38910,38911,38912,38913,38914,38915,38917,38918,38919,38920,38921,38922,38923,38924,
    38925,38926,38927,38928,38929,38930,38931,38932,38933,38934,38935,38936,38937,38938,38939,38940,38941,38942,38943,
    38944,38945,38946,38947,38948,38949,38950,38951,38953,38954,38955,38956,38959,38960,38961,38962,38963,38964,38965,
    38966,38967,38968,38969,38971,38972,38973,38974,38975,38976,38977,38978,38979,38980,38981,38982,38984,38985,38986,
    38987,38988,38989,38990,38991,38992,38993,38995,38997,38998,38999,39000,39001,39002,39003,38790,39004,39005,39006,
    41146,41167,41601,41602,41603,41604,41611,41976,42500,4265,43987,4405,4406,44067,44068,44069,4407,44075,44129,44130,
    44131,44132,44133,44134,44135,44136,44137,44138,44139,44140,44141,44149,44150,44152,44159,44449,44453,44455,44456,
    44457,44458,44463,44465,44466,44467,44469,44470,44493,44497,44701,44702,44739,44815,44936,44946,44947,44957,44963,
    5421,6041,6042,6043,7967,7969,8173,28878
}

local lengths = {}
local times = {}
local calls = {}
local real_calls = {}
local failures = 0

for x,y in ipairs(cases) do
    local f = assert(io.open("tooltips/clean/"..y))
    local tmp = f:read("*all")
    f:close()

    local start = os.clock()
    local startcalls = peg.calls
    local startreal_calls = peg.real_calls

    local results = expression(tmp)
    if results==nil then
        --io.stderr:write("Can't match: ",tmp,"\n")
        failures = failures + 1
    else
        debugPrint(results)
    end


    table.insert(calls,peg.calls-startcalls)
    table.insert(real_calls,peg.real_calls-startreal_calls)
    table.insert(times,os.clock()-start)
    table.insert(lengths,#tmp)
end

print("lengths;calls;real_calls;times")
for i=1, #cases do
    print(lengths[i]..";"..calls[i]..";"..real_calls[i]..";"..string.format("%.5f", times[i]))
end

io.stderr:write(string.format("%.2f%% matches (%d from %d)\n",100-100*failures/#cases, #cases-failures, #cases))
